{% extends 'admin_base.html' %}

{% block admin_module %}
  <form id="add-book-form" class="row g-3" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="col-4">
      <label for="book-title" class="form-label text-secondary">书名</label>
      <input type="text" class="form-control" id="book-title">
    </div>
    <div class="col-4">
      <label for="book-isbn" class="form-label text-secondary">ISBN</label>
      <input type="text" class="form-control" id="book-isbn">
    </div>
    <br>
    <div class="col-4">
      <label for="book-cover" class="form-label text-secondary">封面</label>
      <input type="file" class="form-control" id="book-cover-upload" accept="image/*">
      <img class="mt-3 mx-auto d-block" id="book-cover" style="width: 70%">
    </div>
    <div class="col-8 mb-3">
      <label for="book-introduction" class="form-label text-secondary">简介</label>
      <textarea class="form-control" id="book-introduction"></textarea>
    </div>

  </form>

  <div class="float-end mt-3">
    <button id="add-field" class="btn btn-outline-success">添加新字段</button>
    <button id="submit-add-book" form="add-book-form" class="btn btn-primary">保存</button>
  </div>
  <body>
  <script>
      $(document).ready(function () {
          const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

          // 选择封面图片后直接展示，而不上传
          $("#book-cover-upload").on('change', function () {
              let file_name = document.getElementById("book-cover-upload").files[0].name,
                  src = window.URL.createObjectURL(this.files[0]); //转成可以在本地预览的格式
              $("#book-cover").attr("src", src);
          });

          // 添加额外字段
          let form = $("#add-book-form");
          $("#add-field").click(function () {
              const extra_field = `
                  <div class="col-12 row mt-2">
                      <div class='col-3'>
                          <input type='text' class='form-control' id='field-name' placeholder='字段名'>
                      </div>
                      <div class='col-9'>
                          <div class="input-group">
                              <input type='text' class='form-control' id='field-value' placeholder='内容'>
                              <button type="button" class="btn btn-outline-danger" onclick="$(this).parent().parent().parent().remove();">删除</button>
                          </div>
                      </div>
                  </div>`;
              form.append(extra_field);
          });

          // ajax发送表单数据，包括文件
          $("#submit-add-book").click(function (e) {
              e.preventDefault();
              let form_data = new FormData();

              // TODO 在此处做表单验证

              let title = $("#book-title").val();
              let isbn = $("#book-isbn").val();
              let cover = $("#book-cover-upload")[0].files[0];
              let introduction = $("#book-introduction").val();

              form_data.append('title', title);
              form_data.append('isbn', isbn);
              form_data.append('cover', cover);
              form_data.append('introduction', introduction);

              // TODO 把额外字段也装进form_data里

              $.ajax({
                  url: '{% url "admin_book_add" %}',
                  type: 'post',
                  headers: {'X-CSRFToken': csrfToken},
                  data: form_data,
                  processData: false,    // 不处理数据
                  contentType: false,    // 不设置内容类型
                  success: function (res) {
                      console.log(res);
                  }
              })

          })
      });
  </script>
  </body>

{% endblock %}